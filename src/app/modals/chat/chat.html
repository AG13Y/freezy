<div class="flex justify-between items-start">
  <h2 mat-dialog-title class="dark:text-white pb-0">
    Chat com {{ targetUser.nome }}
  </h2>

  
    <button mat-icon-button 
            aria-label="Iniciar chamada"
            (click)="onCallClick()" 
            class="mt-4 mr-24">
      <mat-icon class="dark:text-white"><span class="material-symbols-outlined">
video_call
</span></mat-icon>
    </button>

  <button mat-icon-button (click)="close()" class="mt-2 mr-2">
    <mat-icon class="dark:text-white">close</mat-icon>
  </button>
</div>

<mat-dialog-content class="h-[60vh] flex flex-col">
  
  <div #messageContainer class="flex-grow overflow-y-auto p-4 space-y-4 bg-gray-100 dark:bg-gray-900 rounded-md">
    
    @if (!chat()) {
      <p class="text-gray-500 dark:text-gray-400 text-center">Carregando histórico...</p>
    }

    @for (message of chat()?.messages; track message.id) {
      <div class="flex" 
           [ngClass]="{ 'justify-end': message.senderId === currentUser.id, 
                         'justify-start': message.senderId !== currentUser.id }">
        
        <div class="max-w-[70%] p-3 rounded-lg shadow"
             [ngClass]="{ 'bg-indigo-600 text-white': message.senderId === currentUser.id, 
                           'bg-white dark:bg-gray-700 dark:text-white': message.senderId !== currentUser.id }">
          <p class="text-sm">{{ message.text }}</p>
          <p class="text-xs opacity-70 mt-1" 
             [ngClass]="{ 'text-right': message.senderId === currentUser.id }">
            {{ message.timestamp | date: 'HH:mm' }}
          </p>
        </div>
      </div>
    } @empty {
      @if(chat()) {
        <p class="text-gray-500 dark:text-gray-400 text-center">
          Nenhuma mensagem ainda. Diga olá!
        </p>
      }
    }
  </div>
</mat-dialog-content>

<mat-dialog-actions class="pt-4 border-t dark:border-gray-700">
  <form (ngSubmit)="sendMessage()" class="flex w-full space-x-2">
    <mat-form-field class="flex-grow" appearance="fill">
      <mat-label>Digite sua mensagem...</mat-label>
      <input matInput [formControl]="messageControl" cdkFocusInitial>
      
    </mat-form-field>
    <button mat-icon-button color="primary" type="submit" [disabled]="messageControl.invalid">
      <mat-icon class="mt-2">send</mat-icon>
    </button>
  </form>
</mat-dialog-actions>
